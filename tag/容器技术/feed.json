{
    "version": "https://jsonfeed.org/version/1",
    "title": "严于律己 宽以待人 • All posts by \"容器技术\" tag",
    "description": "",
    "home_page_url": "https://wmingchong.github.io",
    "items": [
        {
            "id": "https://wmingchong.github.io/2022/12/23/BigData/k8s/",
            "url": "https://wmingchong.github.io/2022/12/23/BigData/k8s/",
            "title": "Kubernetes",
            "date_published": "2022-12-23T07:21:22.000Z",
            "content_html": "<h1 id=\"kubernetes\"><a class=\"markdownIt-Anchor\" href=\"#kubernetes\">#</a> Kubernetes</h1>\n<h2 id=\"概述\"><a class=\"markdownIt-Anchor\" href=\"#概述\">#</a> 概述</h2>\n<ul>\n<li>\n<p>Kubernetes 这个名字源于希腊语，意为 “舵手” 或 “飞行员”。k8s 这个缩写是因为 k 到 s 中间有 8 个字符的关系。</p>\n</li>\n<li>\n<p>Kubernetes 是一个可移植、可扩展的开源平台，用于管理容器化的工作负载和服务，可促进声明式配置和自动化。Kubernetes 拥有一个庞大且快速增生的生态，其服务、支持和工具的使用范围相当广泛。</p>\n</li>\n</ul>\n<h3 id=\"为什么需要kubernetes\"><a class=\"markdownIt-Anchor\" href=\"#为什么需要kubernetes\">#</a> 为什么需要 Kubernetes</h3>\n<p>容器是打包和运行应用程序的好方式，在生产环境中，你需要管理应用程序的容器，并确保不会下线，一旦一个容器发生故障，则需要启动另一个容器，而 k8s 为你提供一个可弹性运行分布式系统的框架，从而满足你的扩展要求，故障转移你的应用、提供部署模式等。</p>\n<p>kubernetes 可以提供：</p>\n<ul>\n<li>\n<p><strong>服务发现和负载均衡</strong></p>\n<p>k8s 可以使用 DNS 名称或自己的 IP 来暴露容器。如果进入容器的流量很大，k8s 可以负载均衡并分配网络流量，从而使部署稳定。</p>\n</li>\n<li>\n<p><strong>存储编排</strong></p>\n<p>k8s 允许你自动挂载你选择的存储系统，例如本地存储，公共云提供商等</p>\n</li>\n<li>\n<p><strong>自动部署和回滚</strong></p>\n<p>你可以使用 kubernetes 描述已部署容器的所需状态，它可以以受控的速率将实际状态更改为期望状态。</p>\n</li>\n<li>\n<p><strong>自动完成装箱计算</strong></p>\n<p>你为 Kubernetes 提供许多节点组成的集群，在这个集群上运行容器化的任务。你告诉 Kubernetes 每个容器需要多少 CPU 和内存 (RAM)。Kubernetes 可以将这些容器按实际情况调度到你的节点上，以最佳方式利用你的资源。</p>\n</li>\n<li>\n<p><strong>自我修复</strong></p>\n<p>kubernetes 将重新启动失败的容器、替换容器、杀死不响应用户定义的运行状况检查的容器，并且在准备好服务之前不将其通告给客户端。</p>\n</li>\n<li>\n<p><strong>密钥与配置管理</strong></p>\n<p>Kubernetes 允许你存储和管理敏感信息，例如密码、OAuth 令牌和 ssh 密钥。你可以在不重建容器镜像的情况下部署和更新密钥和应用程序配置，也无需在堆栈配置中暴露密钥。</p>\n</li>\n</ul>\n<h3 id=\"kubernetes组件\"><a class=\"markdownIt-Anchor\" href=\"#kubernetes组件\">#</a> Kubernetes 组件</h3>\n<p><em><strong>控制平面组件（Control Plane Components）</strong></em></p>\n<ul>\n<li>\n<p><strong> <code>kube-apiserver</code> </strong>:API 服务器是 Kubernetes 控制平面的组件， 该组件负责公开了 Kubernetes API，负责处理接受请求的工作。 API 服务器是 Kubernetes 控制平面的前端。</p>\n</li>\n<li>\n<p><strong> <code>etcd</code> </strong>: 是兼顾一致性与高可用性的键值数据库，可以作为保存 Kubernetes 所有集群数据的后台数据库。</p>\n<p>你的 Kubernetes 集群的 etcd 数据库通常需要有个备份计划。</p>\n</li>\n<li>\n<p><strong> <code>kube-scheduler</code> </strong>:kube-scheduler 是控制平面的组件， 负责监视新创建的、未指定运行节点（node）的 Pods， 并选择节点来让 Pod 在上面运行。</p>\n</li>\n<li>\n<p><strong> <code>kube-controller-manager</code> </strong>: 是控制平面的组件， 负责运行控制器进程。</p>\n<p>从逻辑上讲， 每个控制器都是一个单独的进程， 但是为了降低复杂性，它们都被编译到同一个可执行文件，并在同一个进程中运行。</p>\n</li>\n<li>\n<p><strong> <code>Cloud Controller Manager</code> </strong>: 一个 Kubernetes 控制平面组件， 嵌入了特定于云平台的控制逻辑。 云控制器管理器（Cloud Controller Manager）允许你将你的集群连接到云提供商的 API 之上， 并将与该云平台交互的组件同与你的集群交互的组件分离开来。</p>\n</li>\n</ul>\n<p><em><strong>Node 组件</strong></em></p>\n<ul>\n<li>\n<p><strong> <code>kubelet</code> </strong>：kubelet 会在集群中每个节点（node）上运行。 它保证容器（containers）都运行在 Pod 中。</p>\n<p>kubelet 接收一组通过各类机制提供给它的 PodSpecs， 确保这些 PodSpecs 中描述的容器处于运行状态且健康。 kubelet 不会管理不是由 Kubernetes 创建的容器。</p>\n</li>\n<li>\n<p><strong> <code>kube-proxy</code> </strong>：是集群中每个节点（node）所上运行的网络代理， 实现 Kubernetes 服务（Service） 概念的一部分。</p>\n<p>kube-proxy 维护节点上的一些网络规则， 这些网络规则会允许从集群内部或外部的网络会话与 Pod 进行网络通信。</p>\n<p>如果操作系统提供了可用的数据包过滤层，则 kube-proxy 会通过它来实现网络规则。 否则，kube-proxy 仅做流量转发。</p>\n</li>\n</ul>\n<h2 id=\"部署k8s集群\"><a class=\"markdownIt-Anchor\" href=\"#部署k8s集群\">#</a> 部署 k8s 集群</h2>\n<h3 id=\"1安装好docker\"><a class=\"markdownIt-Anchor\" href=\"#1安装好docker\">#</a> 1. 安装好 Docker</h3>\n<h3 id=\"2安装kubeadm\"><a class=\"markdownIt-Anchor\" href=\"#2安装kubeadm\">#</a> 2. 安装 Kubeadm</h3>\n<ul>\n<li><strong>1. 基础环境</strong></li>\n</ul>\n<blockquote>\n<p>所有机器执行</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#各个机器设置自己的域名</span></span><br><span class=\"line\">hostnamectl set-hostname xxxx</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将 SELinux 设置为 permissive 模式（相当于将其禁用）</span></span><br><span class=\"line\">sudo setenforce 0</span><br><span class=\"line\">sudo sed -i <span class=\"string\">&#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27;</span> /etc/selinux/config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#关闭swap</span></span><br><span class=\"line\">swapoff -a  </span><br><span class=\"line\">sed -ri <span class=\"string\">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#允许 iptables 检查桥接流量</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF | sudo tee /etc/modules-load.d/k8s.conf</span></span><br><span class=\"line\"><span class=\"string\">br_netfilter</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF | sudo tee /etc/sysctl.d/k8s.conf</span></span><br><span class=\"line\"><span class=\"string\">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class=\"line\"><span class=\"string\">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">sudo sysctl --system</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>2.<strong> 安装 Kubelet、Kubeadm、Kubectl</strong></li>\n</ul>\n<blockquote>\n<p>每台机器都执行</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span></span><br><span class=\"line\"><span class=\"string\">[kubernetes]</span></span><br><span class=\"line\"><span class=\"string\">name=Kubernetes</span></span><br><span class=\"line\"><span class=\"string\">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class=\"line\"><span class=\"string\">enabled=1</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">repo_gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span></span><br><span class=\"line\"><span class=\"string\">   http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class=\"line\"><span class=\"string\">exclude=kubelet kubeadm kubectl</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sudo yum install -y kubelet-1.20.9 kubeadm-1.20.9 kubectl-1.20.9 --disableexcludes=kubernetes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sudo systemctl <span class=\"built_in\">enable</span> --now kubelet</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>kubelet 现在每隔几秒就会重启，因为它陷入了一个等待 kubeadm 指令的死循环</p>\n</blockquote>\n<h3 id=\"3使用kubeadm引导集群\"><a class=\"markdownIt-Anchor\" href=\"#3使用kubeadm引导集群\">#</a> 3. 使用 Kubeadm 引导集群</h3>\n<ul>\n<li><strong>1. 下载各个机器所需要的镜像</strong></li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo <span class=\"built_in\">tee</span> ./images.sh &lt;&lt;-<span class=\"string\">&#x27;EOF&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\">images=(</span><br><span class=\"line\">kube-apiserver:v1.20.9</span><br><span class=\"line\">kube-proxy:v1.20.9</span><br><span class=\"line\">kube-controller-manager:v1.20.9</span><br><span class=\"line\">kube-scheduler:v1.20.9</span><br><span class=\"line\">coredns:1.7.0</span><br><span class=\"line\">etcd:3.4.13-0</span><br><span class=\"line\">pause:3.2</span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"keyword\">for</span> imageName <span class=\"keyword\">in</span> <span class=\"variable\">$&#123;images[@]&#125;</span> ; <span class=\"keyword\">do</span></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/<span class=\"variable\">$imageName</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\">   </span><br><span class=\"line\"><span class=\"built_in\">chmod</span> +x ./images.sh &amp;&amp; ./images.sh</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>2. 初始化主节点</strong></li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#所有机器添加master域名映射，以下需要修改为自己的</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;172.31.0.2  cluster-endpoint&quot;</span> &gt;&gt; /etc/hosts</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#主节点初始化</span></span><br><span class=\"line\">kubeadm init \\</span><br><span class=\"line\">--apiserver-advertise-address=172.31.0.2 \\</span><br><span class=\"line\">--control-plane-endpoint=cluster-endpoint \\</span><br><span class=\"line\">--image-repository registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images \\</span><br><span class=\"line\">--kubernetes-version v1.20.9 \\</span><br><span class=\"line\">--service-cidr=10.96.0.0/16 \\</span><br><span class=\"line\">--pod-network-cidr=192.168.0.0/16</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#所有网络范围不重叠</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>一些简单的 kubectl 命令</strong></li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#查看集群所有节点</span></span><br><span class=\"line\">kubectl get nodes</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#根据配置文件，给集群创建资源</span></span><br><span class=\"line\">kubectl apply -f xxxx.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看集群部署了哪些应用？</span></span><br><span class=\"line\">docker ps   ===   kubectl get pods -A</span><br><span class=\"line\"><span class=\"comment\"># 运行中的应用在docker里面叫容器，在k8s里面叫Pod</span></span><br><span class=\"line\">kubectl get pods -A</span><br></pre></td></tr></table></figure>\n<h3 id=\"4初始化后根据提示进行操作\"><a class=\"markdownIt-Anchor\" href=\"#4初始化后根据提示进行操作\">#</a> 4. 初始化后根据提示进行操作</h3>\n<blockquote>\n<p>下面是主节点初始化之后所给出的后续操作提示，除了提示在 node 节点运行，其他都在 master 节点执行</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Your Kubernetes control-plane has initialized successfully!</span><br><span class=\"line\"></span><br><span class=\"line\">To start using your cluster, you need to run the following as a regular user:</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">  sudo <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">  sudo <span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\">Alternatively, <span class=\"keyword\">if</span> you are the root user, you can run:</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class=\"line\"></span><br><span class=\"line\">You should now deploy a pod network to the cluster.</span><br><span class=\"line\">Run <span class=\"string\">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class=\"line\">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class=\"line\"></span><br><span class=\"line\">You can now <span class=\"built_in\">join</span> any number of control-plane nodes by copying certificate authorities</span><br><span class=\"line\">and service account keys on each node and <span class=\"keyword\">then</span> running the following as root:</span><br><span class=\"line\"></span><br><span class=\"line\">  kubeadm <span class=\"built_in\">join</span> cluster-endpoint:6443 --token 2g3c5s.fkdy4jkh3npjma1g \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:9f45cf5a17fa96087e7a708ab0234c0d6851aa6bc3ffe98fe7d5b282d3810664 \\</span><br><span class=\"line\">    --control-plane </span><br><span class=\"line\"></span><br><span class=\"line\">Then you can <span class=\"built_in\">join</span> any number of worker nodes by running the following on each as root:</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm <span class=\"built_in\">join</span> cluster-endpoint:6443 --token 2g3c5s.fkdy4jkh3npjma1g \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:9f45cf5a17fa96087e7a708ab0234c0d6851aa6bc3ffe98fe7d5b282d3810664 </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>1. 设置.kube/config</strong></li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">sudo <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">sudo <span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>安装网络组件</strong></li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl https://docs.projectcalico.org/manifests/calico.yaml -O</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure>\n<h3 id=\"5加入node节点\"><a class=\"markdownIt-Anchor\" href=\"#5加入node节点\">#</a> 5. 加入 node 节点</h3>\n<blockquote>\n<p>在 node 节点上执行，在上面提示中，根据自己的提示添加</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm <span class=\"built_in\">join</span> cluster-endpoint:6443 --token 2g3c5s.fkdy4jkh3npjma1g \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:9f45cf5a17fa96087e7a708ab0234c0d6851aa6bc3ffe98fe7d5b282d3810664 </span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>令牌有效期 24h，如果时间到了，可以使用命令获取新令牌</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>\n<h3 id=\"6验证集群\"><a class=\"markdownIt-Anchor\" href=\"#6验证集群\">#</a> 6. 验证集群</h3>\n<ul>\n<li>验证节点状态</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get nodes</span><br></pre></td></tr></table></figure>\n<h3 id=\"7部署dashboard\"><a class=\"markdownIt-Anchor\" href=\"#7部署dashboard\">#</a> 7. 部署 dashboard</h3>\n<ul>\n<li>1. 部署</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure>\n<ul>\n<li>2. 设置访问端口</li>\n</ul>\n<blockquote>\n<p>在里面输入：/type 回车。将 type: ClusterIP 改为 type: NodePort</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get svc -A |grep kubernetes-dashboard</span><br><span class=\"line\"><span class=\"comment\">## 运行后会出现端口，找到端口，在安全组放行</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>网页上访问： <span class=\"exturl\" data-url=\"aHR0cHM6Ly94bi0tSVAtZGgzY3I5OWRuNDhhZzkyYQ==\">https:// 集群任意 IP</span>: 端口      <span class=\"exturl\" data-url=\"aHR0cHM6Ly8xMzkuMTk4LjE1LjgxOjMyNzU2\">https://139.198.15.81:32756</span></p>\n</blockquote>\n<ul>\n<li>3. 创建访问账号</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#创建访问账号，准备一个yaml文件； vi dash.yaml，将下面内容复制到文件中</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">admin-user</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kubernetes-dashboard</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">admin-user</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cluster-admin</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">admin-user</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用文件</span></span><br><span class=\"line\">kubectl apply -f dash.yaml</span><br></pre></td></tr></table></figure>\n<ul>\n<li>4. 使用令牌访问</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#获取访问令牌</span></span><br><span class=\"line\">kubectl -n kubernetes-dashboard get secret $(kubectl -n kubernetes-dashboard get sa/admin-user -o jsonpath=<span class=\"string\">&quot;&#123;.secrets[0].name&#125;&quot;</span>) -o go-template=<span class=\"string\">&quot;&#123;&#123;.data.token | base64decode&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eyJhbGciOiJSUzI1NiIsImtpZCI6IllYSXU5cUZUSVJ5Rzg5Z21FYldkYUY4ZnBrZGtzSjBobHZORDFodHJEWDAifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLTZ4amttIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiIzMzVkYTBlYS01NTM1LTRmMzEtYTdiMS00Nzc5ODdjZWUyMjciLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.D_D66M5Qq1ifwIktD0pk2HwSTXOZKJmeSElQ0KNb5du6h39WkImRE1BSMGq8YBDhLyxZH4yWjZDQ1TW-T2TSTjaYFv6QYOYa1ruynxmozEnok3fSTy60frHGaaP0KenJaspOzJP7uWtZOi4ayoRlgD6Ld4JQTs3JQvASxXN59-DX4mw2<span class=\"number\">-9</span>mikoOsL3cJn8RO_egDIyjn3tnDgFfaP1FDchyKGl<span class=\"number\">-1</span>nAKIe5kZYn1x49sAU0mzBvdT9KdFn4SG6X_52KYeR4rarfkQBYqF8upCg7aXyEJ80hsvnoayXBvHVtNnGEKwEPgZAaxqsi6tTmRR-iKvZ9HPAET4aJQFrQdSVA</span><br></pre></td></tr></table></figure>\n<ul>\n<li>5. 在页面输入令牌即可进入 kubernetes 界面</li>\n</ul>\n<h2 id=\"kubernetes实战\"><a class=\"markdownIt-Anchor\" href=\"#kubernetes实战\">#</a> Kubernetes 实战</h2>\n<h3 id=\"1nmaespace\"><a class=\"markdownIt-Anchor\" href=\"#1nmaespace\">#</a> 1.NmaeSpace</h3>\n<ul>\n<li>NameSpace：名称空间，用来对集群资源济宁隔离划分。默认只隔离资源，不隔离网络</li>\n</ul>\n<blockquote>\n<p>名称空间用来隔离资源</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建名称空间</span></span><br><span class=\"line\">kubectl create ns hello</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除名称空间</span></span><br><span class=\"line\">kubectl delete ns hello</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 用yaml文件创建名称空间，如hello.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Namespace</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">hello</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\"># 使用hello.yaml文件</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">apply</span> <span class=\"string\">-f</span> <span class=\"string\">hello.yaml</span></span><br><span class=\"line\"><span class=\"comment\"># 删除yaml文件创建的名称空间</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">delete</span> <span class=\"string\">-f</span> <span class=\"string\">hello.yaml</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"2pod\"><a class=\"markdownIt-Anchor\" href=\"#2pod\">#</a> 2.Pod</h3>\n<blockquote>\n<p>Pod: 运行中的一组容器，Pod 是 kubernetes 中应用的最小单位.</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建一个pod，--image指定镜像，-n指定名称空间，不写则是放在默认名称空间default中</span></span><br><span class=\"line\"><span class=\"comment\"># 命令行创建</span></span><br><span class=\"line\">kubectl run mynginx --image=nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看default名称空间的Pod</span></span><br><span class=\"line\">kubectl get pod </span><br><span class=\"line\"><span class=\"comment\"># 描述</span></span><br><span class=\"line\">kubectl describe pod 你自己的Pod名字</span><br><span class=\"line\"><span class=\"comment\"># 删除默认名称空间的pod，如果要删除其他名称空间的pod，加上：-n 名称空间</span></span><br><span class=\"line\">kubectl delete pod Pod名字 -n 名称空间</span><br><span class=\"line\"><span class=\"comment\"># 查看Pod的运行日志，-f阻塞式追踪：有日志就显示</span></span><br><span class=\"line\">kubectl logs Pod名字</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 每个Pod - k8s都会分配一个ip</span></span><br><span class=\"line\">kubectl get pod -owide</span><br><span class=\"line\"><span class=\"comment\"># 使用Pod的ip+pod里面运行容器的端口</span></span><br><span class=\"line\">curl 192.168.169.136</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 集群中的任意一个机器以及任意的应用都能通过Pod分配的ip来访问这个Pod</span></span><br><span class=\"line\"><span class=\"comment\">#每隔一秒运行命令</span></span><br><span class=\"line\">watch -n 1 kubectl get pod</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># yaml文件创建Pod</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">run:</span> <span class=\"string\">mynginx</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mynginx</span>  <span class=\"comment\"># pod的名称</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"comment\">#  namespace: default 指定名称空间 </span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx</span>  <span class=\"comment\">#指定镜像</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">mynginx</span>  <span class=\"comment\"># 容器名称</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"3deployment\"><a class=\"markdownIt-Anchor\" href=\"#3deployment\">#</a> 3.Deployment</h3>\n<blockquote>\n<p>控制 Pod，使 Pod 拥有多副本，自愈，扩缩容等能力</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 清除所有Pod，比较下面两个命令有何不同效果？</span></span><br><span class=\"line\">kubectl run mynginx --image=nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 自愈能力，使用delete pod删除会重新运行一个pod，要彻底删除使用delete deploy</span></span><br><span class=\"line\">kubectl create deployment mytomcat --image=tomcat:8.5.68</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>1.<strong> 多副本</strong></li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用命令行部署一个应用，有三个副本</span></span><br><span class=\"line\">kubectl create deployment my-dep --image=nginx --replicas=3</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用yaml文件部署</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">my-dep</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-dep</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">my-dep</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">my-dep</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>2. 扩缩容</strong></li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kubectl scale扩缩容</span></span><br><span class=\"line\">kubectl scale --replicas=5 deployment/my-dep</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl edit deployment my-dep</span><br><span class=\"line\"><span class=\"comment\">#修改文件中 replicas</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>\n<p><strong>3. 自愈 &amp; 故障转移</strong></p>\n<ul>\n<li>\n<p>停机</p>\n</li>\n<li>\n<p>删除 Pod</p>\n</li>\n<li>\n<p>容器崩溃</p>\n</li>\n<li>\n<p>…</p>\n</li>\n</ul>\n</li>\n<li>\n<p><strong>4. 滚动更新</strong></p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kubectl set image 更新镜像</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">set</span> image deployment/my-dep nginx=nginx:1.16.1 --record</span><br><span class=\"line\">kubectl rollout status deployment/my-dep</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 修改 kubectl edit deployment/my-dep</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>5. 版本回退</strong></li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#历史记录</span></span><br><span class=\"line\">kubectl rollout <span class=\"built_in\">history</span> deployment/my-dep</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看某个历史详情</span></span><br><span class=\"line\">kubectl rollout <span class=\"built_in\">history</span> deployment/my-dep --revision=2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#回滚(回到上次)</span></span><br><span class=\"line\">kubectl rollout undo deployment/my-dep</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#回滚(回到指定版本)</span></span><br><span class=\"line\">kubectl rollout undo deployment/my-dep --to-revision=2</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>更多：</p>\n<p>除了 Deployment，k8s 还有  <code>StatefulSet</code>  、 <code>DaemonSet</code>  、 <code>Job</code>   等 类型资源。我们都称为  <code>工作负载</code> 。</p>\n<p>有状态应用使用   <code>StatefulSet</code>   部署，无状态应用使用  <code>Deployment</code>  部署</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL2NvbnRyb2xsZXJzLw==\">https://kubernetes.io/zh/docs/concepts/workloads/controllers/</span></p>\n</blockquote>\n<ul>\n<li><strong>其他工作负载</strong>\n<ul>\n<li>Deployment：无状态应用部署，比如微服务，提供多副本等功能</li>\n<li>StatefulSet: 有状态应用部署，比如 redis，提供稳定的存储、网络等功能</li>\n<li>DaemonSet: 守护型应用部署，比如日志收集组件，在每个机器都运行一份</li>\n<li>Job/CronJob：定时任务部署，比如垃圾清理组件，可以在指定时间运行</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"4service\"><a class=\"markdownIt-Anchor\" href=\"#4service\">#</a> 4.Service</h3>\n<blockquote>\n<p>将一组 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL3BvZHMvcG9kLW92ZXJ2aWV3Lw==\">Pods</span> 公开为网络服务的抽象方法。</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#暴露Deploy,集群内使用service的ip：port就可以负载均衡访问</span></span><br><span class=\"line\">kubectl expose deployment my-dep --port=8000 --target-port=80 </span><br><span class=\"line\"><span class=\"comment\"># --type=ClusterIP 集群IP，只能在集群内部访问</span></span><br><span class=\"line\"><span class=\"comment\"># --type=NodePort 节点端口，可以在集群外部访问</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在应用内部也可以通过   服务名.所在名称空间.csv:端口  访问</span></span><br><span class=\"line\">curl my-dep.default.csv:8000</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#使用标签检索Pod</span></span><br><span class=\"line\">kubectl get pod -l app=my-dep</span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>1.ClusterIP</strong></li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 等同于没有--type的</span></span><br><span class=\"line\">kubectl expose deployment my-dep --port=8000 --target-port=80 --<span class=\"built_in\">type</span>=ClusterIP</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">my-dep</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-dep</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">8000</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">my-dep</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li><strong>2.NodePort</strong></li>\n</ul>\n<blockquote>\n<p>NodePort 范围在 30000-32767 之间</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># --type=NodePort 在集群外负载均衡访问</span></span><br><span class=\"line\">kubectl expose deployment my-dep --port=8000 --target-port=80 --<span class=\"built_in\">type</span>=NodePort</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">my-dep</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-dep</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">8000</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">my-dep</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">NodePort</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"5ingress\"><a class=\"markdownIt-Anchor\" href=\"#5ingress\">#</a> 5.Ingress</h3>\n<blockquote>\n<p>Service 的统一网关入口</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.47.0/deploy/static/provider/baremetal/deploy.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改镜像</span></span><br><span class=\"line\">vi deploy.yaml</span><br><span class=\"line\"><span class=\"comment\">#将image的值改为如下值：</span></span><br><span class=\"line\">registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/ingress-nginx-controller:v0.46.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检查安装的结果</span></span><br><span class=\"line\">kubectl get pod,svc -n ingress-nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 最后别忘记把svc暴露的端口要放行</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"6存储抽象\"><a class=\"markdownIt-Anchor\" href=\"#6存储抽象\">#</a> 6. 存储抽象</h3>\n<h4 id=\"环境准备\"><a class=\"markdownIt-Anchor\" href=\"#环境准备\">#</a> 环境准备</h4>\n<p>1. 所有节点</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#所有机器安装</span></span><br><span class=\"line\">yum install -y nfs-utils</span><br></pre></td></tr></table></figure>\n<p>2. 主节点</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#nfs主节点</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;/nfs/data/ *(insecure,rw,sync,no_root_squash)&quot;</span> &gt; /etc/exports</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /nfs/data</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> rpcbind --now</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> nfs-server --now</span><br><span class=\"line\"><span class=\"comment\">#配置生效</span></span><br><span class=\"line\">exportfs -r</span><br></pre></td></tr></table></figure>\n<p>3. 从节点</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">showmount -e 172.31.0.2  <span class=\"comment\"># 自己主节点的IP</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#执行以下命令挂载 nfs 服务器上的共享目录到本机路径 /root/nfsmount</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /nfs/data</span><br><span class=\"line\"></span><br><span class=\"line\">mount -t nfs 172.31.0.2:/nfs/data /nfs/data</span><br><span class=\"line\"><span class=\"comment\"># 写入一个测试文件</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;hello nfs server&quot;</span> &gt; /nfs/data/test.txt</span><br></pre></td></tr></table></figure>\n<p>4. 原生方式数据挂载</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx-pv-demo</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-pv-demo</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-pv-demo</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx-pv-demo</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">html</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/nginx/html</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">html</span></span><br><span class=\"line\">          <span class=\"attr\">nfs:</span></span><br><span class=\"line\">            <span class=\"attr\">server:</span> <span class=\"number\">172.31</span><span class=\"number\">.0</span><span class=\"number\">.2</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/nfs/data/nginx-pv</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"pv-pvc\"><a class=\"markdownIt-Anchor\" href=\"#pv-pvc\">#</a> PV &amp; PVC</h4>\n<blockquote>\n<p><em>PV：持久卷（Persistent Volume），将应用需要持久化的数据保存到指定位置</em></p>\n<p><em>PVC：持久卷申明（<strong>Persistent Volume Claim</strong>），申明需要使用的持久卷规格</em></p>\n</blockquote>\n<p>1. 创建 PV 池</p>\n<blockquote>\n<p>静态创建</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#nfs主节点</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /nfs/data/01</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /nfs/data/02</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /nfs/data/03</span><br></pre></td></tr></table></figure>\n<p>2. 创建 PV</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pv01-10m</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">capacity:</span></span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">10M</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">storageClassName:</span> <span class=\"string\">nfs</span></span><br><span class=\"line\">  <span class=\"attr\">nfs:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/nfs/data/01</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"number\">172.31</span><span class=\"number\">.0</span><span class=\"number\">.2</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pv02-1gi</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">capacity:</span></span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">storageClassName:</span> <span class=\"string\">nfs</span></span><br><span class=\"line\">  <span class=\"attr\">nfs:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/nfs/data/02</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"number\">172.31</span><span class=\"number\">.0</span><span class=\"number\">.2</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pv03-3gi</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">capacity:</span></span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">3Gi</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">storageClassName:</span> <span class=\"string\">nfs</span></span><br><span class=\"line\">  <span class=\"attr\">nfs:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/nfs/data/03</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"number\">172.31</span><span class=\"number\">.0</span><span class=\"number\">.2</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"pvc创建与绑定\"><a class=\"markdownIt-Anchor\" href=\"#pvc创建与绑定\">#</a> PVC 创建与绑定</h4>\n<blockquote>\n<p>创建 pvc</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-pvc</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span></span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">200Mi</span></span><br><span class=\"line\">  <span class=\"attr\">storageClassName:</span> <span class=\"string\">nfs</span></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>创建 pod 绑定 pvc</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx-deploy-pvc</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-deploy-pvc</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-deploy-pvc</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx-deploy-pvc</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">html</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/nginx/html</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">html</span></span><br><span class=\"line\">          <span class=\"attr\">persistentVolumeClaim:</span></span><br><span class=\"line\">            <span class=\"attr\">claimName:</span> <span class=\"string\">nginx-pvc</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"configmap\"><a class=\"markdownIt-Anchor\" href=\"#configmap\">#</a> ConfigMap</h4>\n<blockquote>\n<p>抽取应用配置，并且可以自动更新</p>\n<p>redis 实例</p>\n</blockquote>\n<p>1. 把之前的配置文件创建为配置集</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建配置，redis保存到k8s的etcd；</span></span><br><span class=\"line\">kubectl create cm redis-conf --from-file=redis.conf</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span>    <span class=\"comment\">#data是所有真正的数据，key：默认是文件名   value：配置文件的内容</span></span><br><span class=\"line\">  <span class=\"attr\">redis.conf:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    appendonly yes</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">redis-conf</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br></pre></td></tr></table></figure>\n<p>2. 创建 pod</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">redis-server</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;/redis-master/redis.conf&quot;</span>  <span class=\"comment\">#指的是redis容器内部的位置</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">6379</span></span><br><span class=\"line\">    <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/data</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/redis-master</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">config</span></span><br><span class=\"line\">  <span class=\"attr\">volumes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">      <span class=\"attr\">emptyDir:</span> &#123;&#125;</span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">config</span></span><br><span class=\"line\">      <span class=\"attr\">configMap:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">redis-conf</span></span><br><span class=\"line\">        <span class=\"attr\">items:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">redis.conf</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">redis.conf</span></span><br></pre></td></tr></table></figure>\n<p>3. 检查默认配置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -it redis -- redis-cli</span><br><span class=\"line\"></span><br><span class=\"line\">127.0.0.1:6379&gt; CONFIG GET appendonly</span><br><span class=\"line\">127.0.0.1:6379&gt; CONFIG GET requirepass</span><br></pre></td></tr></table></figure>\n<p>4. 修改 ConfigMap</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">example-redis-config</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">redis-config:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    maxmemory 2mb</span></span><br><span class=\"line\"><span class=\"string\">    maxmemory-policy allkeys-lru </span></span><br></pre></td></tr></table></figure>\n<p>5. 检查配置是否更新</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -it redis -- redis-cli</span><br><span class=\"line\"></span><br><span class=\"line\">127.0.0.1:6379&gt; CONFIG GET maxmemory</span><br><span class=\"line\">127.0.0.1:6379&gt; CONFIG GET maxmemory-policy</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>检查指定文件内容是否已经更新</p>\n<p>修改了 CM。Pod 里面的配置文件会跟着变</p>\n</blockquote>\n<blockquote>\n<p>配置值未更改，因为需要重新启动 Pod 才能从关联的 ConfigMap 中获取更新的值。原因：我们的 Pod 部署的中间件自己本身没有热更新能力</p>\n</blockquote>\n<h4 id=\"secret\"><a class=\"markdownIt-Anchor\" href=\"#secret\">#</a> Secret</h4>\n<blockquote>\n<p>Secret 对象类型用来保存敏感信息，例如密码、OAuth 令牌和 SSH 密钥。 将这些信息放在 secret 中比放在 Pod 的定义或者 容器镜像 中来说更加安全和灵活。</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create secret docker-registry wmchong-docker \\</span><br><span class=\"line\">--docker-username=wmchong \\</span><br><span class=\"line\">--docker-password=wmc5201314 \\</span><br><span class=\"line\">--docker-email=2022453755@qq.com</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">##命令格式</span></span><br><span class=\"line\">kubectl create secret docker-registry regcred \\</span><br><span class=\"line\">  --docker-server=&lt;你的镜像仓库服务器&gt; \\</span><br><span class=\"line\">  --docker-username=&lt;你的用户名&gt; \\</span><br><span class=\"line\">  --docker-password=&lt;你的密码&gt; \\</span><br><span class=\"line\">  --docker-email=&lt;你的邮箱地址&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">private-nginx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">private-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">wmchong/wmc:v1.0</span></span><br><span class=\"line\">  <span class=\"attr\">imagePullSecrets:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">wmchong-docker</span></span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "容器技术"
            ]
        },
        {
            "id": "https://wmingchong.github.io/2022/12/23/BigData/docker/",
            "url": "https://wmingchong.github.io/2022/12/23/BigData/docker/",
            "title": "Docker",
            "date_published": "2022-12-23T07:08:24.000Z",
            "content_html": "<h2 id=\"docker\"><a class=\"markdownIt-Anchor\" href=\"#docker\">#</a> Docker</h2>\n<p>容器化技术</p>\n<ul>\n<li>1、基础镜像 MB 级别</li>\n<li>创建简单</li>\n<li>隔离性强</li>\n<li>启动速度秒级</li>\n<li>移植与分享</li>\n</ul>\n<h2 id=\"安装docker\"><a class=\"markdownIt-Anchor\" href=\"#安装docker\">#</a> 安装 Docker</h2>\n<h2 id=\"1centos下安装docker\"><a class=\"markdownIt-Anchor\" href=\"#1centos下安装docker\">#</a> 1.Centos 下安装 docker</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vZW5naW5lL2luc3RhbGwvY2VudG9zLw==\">其它系统安装参考</span></p>\n<h3 id=\"1如果有请移除以前的docker相关包\"><a class=\"markdownIt-Anchor\" href=\"#1如果有请移除以前的docker相关包\">#</a> 1. 如果有，请移除以前的 docker 相关包</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum remove docker \\</span><br><span class=\"line\">                  docker-client \\</span><br><span class=\"line\">                  docker-client-latest \\</span><br><span class=\"line\">                  docker-common \\</span><br><span class=\"line\">                  docker-latest \\</span><br><span class=\"line\">                  docker-latest-logrotate \\</span><br><span class=\"line\">                  docker-logrotate \\</span><br><span class=\"line\">                  docker-engine</span><br></pre></td></tr></table></figure>\n<p>此过程是需要在 root 权限下进行，如果已经是 root 权限可不用 sudo, 后面的命令也是如此</p>\n<h3 id=\"2配置yum源\"><a class=\"markdownIt-Anchor\" href=\"#2配置yum源\">#</a> 2. 配置 yum 源</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum install -y yum-utils</span><br><span class=\"line\">sudo yum-config-manager \\</span><br><span class=\"line\">--add-repo \\</span><br><span class=\"line\">http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>\n<h3 id=\"3安装docker\"><a class=\"markdownIt-Anchor\" href=\"#3安装docker\">#</a> 3. 安装 docker</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum install -y docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>\n<p>如果此过程提示‘No package docker-ce available’，请参考<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3RhbndlaTAxMDkxNS9hcnRpY2xlL2RldGFpbHMvMTIzNjI5MDk2\">这篇博客</span></p>\n<h3 id=\"4启动docker\"><a class=\"markdownIt-Anchor\" href=\"#4启动docker\">#</a> 4. 启动 Docker</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl <span class=\"built_in\">enable</span> docker --now</span><br></pre></td></tr></table></figure>\n<h3 id=\"5配置镜像下载加速\"><a class=\"markdownIt-Anchor\" href=\"#5配置镜像下载加速\">#</a> 5. 配置镜像下载加速</h3>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo mkdir -p /etc/docker</span><br><span class=\"line\">sudo tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;registry-mirrors&quot;: [&quot;https://lmccrgeo.mirror.aliyuncs.com&quot;],</span><br><span class=\"line\">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class=\"line\">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class=\"line\">  &quot;log-opts&quot;: &#123;</span><br><span class=\"line\">    &quot;max-size&quot;: &quot;100m&quot;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  &quot;storage-driver&quot;: &quot;overlay2&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">sudo systemctl daemon-reload</span><br><span class=\"line\">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>\n<p>其中 &quot;registry-mirrors&quot; 的参数可设置为自己的加速地址，在个人阿里云的<strong>容器与镜像服务</strong>中查看<strong>镜像加速器地址</strong>。echo “172.31.0.2  cluster-endpoint” &gt;&gt; /etc/hosts</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm init \\</span><br><span class=\"line\">--apiserver-advertise-address=172.31.0.2 \\</span><br><span class=\"line\">--control-plane-endpoint=cluster-endpoint \\</span><br><span class=\"line\">--image-repository registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images \\</span><br><span class=\"line\">--kubernetes-version v1.20.9 \\</span><br><span class=\"line\">--service-cidr=10.96.0.0/16 \\</span><br><span class=\"line\">--pod-network-cidr=192.168.0.0/16</span><br></pre></td></tr></table></figure>\n<h2 id=\"docker基本操作\"><a class=\"markdownIt-Anchor\" href=\"#docker基本操作\">#</a> Docker 基本操作</h2>\n<h3 id=\"1拉镜像\"><a class=\"markdownIt-Anchor\" href=\"#1拉镜像\">#</a> 1. 拉镜像</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 镜像名:版本号，不写版本号默认最新版，即latest</span></span><br><span class=\"line\">docker pull nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看所有镜像</span></span><br><span class=\"line\">docker images</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#删除镜像</span></span><br><span class=\"line\">docker rmi 镜像名/ID</span><br></pre></td></tr></table></figure>\n<p>也可以在<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZG9ja2VyLmNvbS9wcm9kdWN0cy9kb2NrZXItaHViLw==\"> DockerHub</span> 里面找自己需要的镜像。</p>\n<h3 id=\"2启动容器\"><a class=\"markdownIt-Anchor\" href=\"#2启动容器\">#</a> 2. 启动容器</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 启动一个容器</span></span><br><span class=\"line\">docker run [OPTIONS] IMAGE [COMMAND] [ARG...]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#一些简单参数：-d：后台运行 --name:命名 --restart=always：开机自启  -p：端口映射(ps:主机的88端口映射到容器80端口 88:80)</span></span><br><span class=\"line\">docker run -d --name dock --restart always 88:80 nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看正在运行的容器</span></span><br><span class=\"line\">docker ps</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看所有容器</span></span><br><span class=\"line\">docker ps -a</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 停止容器</span></span><br><span class=\"line\">docker stop 容器<span class=\"built_in\">id</span>/名字</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#再次启动</span></span><br><span class=\"line\">docker start 容器<span class=\"built_in\">id</span>/名字</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除停止的容器，若要强制删除加 -f</span></span><br><span class=\"line\">docker <span class=\"built_in\">rm</span> 容器名/ID</span><br><span class=\"line\">docker <span class=\"built_in\">rm</span> -f 容器名/ID</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#应用开机自启</span></span><br><span class=\"line\">docker update 容器<span class=\"built_in\">id</span>/名字 --restart=always</span><br></pre></td></tr></table></figure>\n<h3 id=\"3页面修改\"><a class=\"markdownIt-Anchor\" href=\"#3页面修改\">#</a> 3. 页面修改</h3>\n<ul>\n<li>进入容器内修改</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#进入容器内部，修改内容  -it：运行交互命令</span></span><br><span class=\"line\">docker <span class=\"built_in\">exec</span> -it 容器名/id</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 以Nginx为例</span></span><br><span class=\"line\"><span class=\"comment\">#进入文件夹</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> usr/share/nginx/html/</span><br><span class=\"line\"><span class=\"comment\"># 修改页面内容， &gt; 是覆盖：将里面内容覆盖；&gt;&gt; 追加：在里面的内容基础上追加</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&lt;h1&gt;Welcome come to Chongqing&lt;/h1&gt;&quot;</span> &gt; index.html</span><br><span class=\"line\"><span class=\"comment\"># 查看index.html的内容</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> index.html</span><br></pre></td></tr></table></figure>\n<ul>\n<li>挂载数据卷到外部修改</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 挂载 -v 主机地址:容器地址 :ro表示只能在容器里进行读操作； :rw 可以进行写操作</span></span><br><span class=\"line\">docker run -d --name gugu -p 88:80 -v /data/html:/usr/share/nginx/html:ro nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果主机文件目录为空，容器也为空</span></span><br><span class=\"line\"><span class=\"comment\"># 挂载完成后，如果需要修改内容直接到主机的 /data/html 下修改即可</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"4提交内容创建自己的镜像\"><a class=\"markdownIt-Anchor\" href=\"#4提交内容创建自己的镜像\">#</a> 4. 提交内容（创建自己的镜像）</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># -a :提交的镜像作者； -c :使用Dockerfile指令来创建镜像； -m :提交时的说明文字； -p :在commit时，将容器暂停。</span></span><br><span class=\"line\">docker commit -a <span class=\"string\">&quot;wmc&quot;</span> -m <span class=\"string\">&quot;首页变化&quot;</span> 24f36308a38a wnginx:v1.0</span><br></pre></td></tr></table></figure>\n<h3 id=\"5镜像传输\"><a class=\"markdownIt-Anchor\" href=\"#5镜像传输\">#</a> 5. 镜像传输</h3>\n<ul>\n<li>压缩包传输</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">####压缩包传输######</span></span><br><span class=\"line\"><span class=\"comment\">#将镜像保存成压缩包  -o :输出到的文件</span></span><br><span class=\"line\">docker save [OPTIONS] IMAGE [IMAGE...]</span><br><span class=\"line\">docker save -o abc.tar wnginx:v1.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将镜像传输给其他机器 </span></span><br><span class=\"line\">scp abc.tar 其他机器地址</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在其他机器上加载  -i : 指定导入的文件，代替 STDIN； -q : 精简输出信息。</span></span><br><span class=\"line\">docker load [OPTIONS]</span><br><span class=\"line\">docker load -i abc.atr</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>远程推送到仓库</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">####远程推送到仓库######</span></span><br><span class=\"line\"><span class=\"comment\"># 将旧镜像名改成需要推送到仓库要求的名称</span></span><br><span class=\"line\">docker tag wnginx:v1.0 wmchong/wmc:v1.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 登录到docker hub（没有需要在网页注册）</span></span><br><span class=\"line\">docker login</span><br><span class=\"line\">docker <span class=\"built_in\">logout</span> <span class=\"comment\"># 推送完后退出</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 推送</span></span><br><span class=\"line\">docker push wmchong/wmc:v1.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在其他机器使用命令拉取镜像</span></span><br><span class=\"line\">docker pull wmchong/wmc:v1.0</span><br></pre></td></tr></table></figure>\n<h3 id=\"6其他命令\"><a class=\"markdownIt-Anchor\" href=\"#6其他命令\">#</a> 6. 其他命令</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run --<span class=\"built_in\">help</span>  <span class=\"comment\"># 可以使用--help，查看帮助文档</span></span><br><span class=\"line\">docker <span class=\"built_in\">log</span> 容器名/ID  <span class=\"comment\"># 查看日志，排错</span></span><br><span class=\"line\">docker <span class=\"built_in\">cp</span> 95e332b7f4b1:/etc/nginx/nginx.conf /data/conf/nginx.conf  <span class=\"comment\"># 将内容进行复制</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## docker 修改配置文件，用挂载的方法</span></span><br><span class=\"line\">docker run -d -p 80:80 -v /data/html:/usr/share/nginx/html:ro -v /data/conf/nginx.conf:/etc/nginx/nginx.conf:ro --name chong nginx</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># redis使用自定义配置文件启动</span></span><br><span class=\"line\">docker run \\</span><br><span class=\"line\">-v /data/redis/redis.conf:/etc/redis/redis.conf \\</span><br><span class=\"line\">-v /data/redis/data:/data \\</span><br><span class=\"line\">-d --name myredis \\</span><br><span class=\"line\">-p 6379:6379 \\</span><br><span class=\"line\">redis redis-server /etc/redis/redis.conf</span><br></pre></td></tr></table></figure>\n<h2 id=\"应用打包-dockerfile\"><a class=\"markdownIt-Anchor\" href=\"#应用打包-dockerfile\">#</a> 应用打包 - DockerFile</h2>\n<h3 id=\"1-以前\"><a class=\"markdownIt-Anchor\" href=\"#1-以前\">#</a> 1、以前</h3>\n<p>Java 为例</p>\n<ul>\n<li>SpringBoot 打包成可执行 jar</li>\n<li>把 jar 包上传给服务</li>\n<li>服务器运行 java -jar</li>\n</ul>\n<h3 id=\"2现在\"><a class=\"markdownIt-Anchor\" href=\"#2现在\">#</a> 2. 现在</h3>\n<p>编写 Dockerfile</p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> openjdk:<span class=\"number\">8</span>-jdk-slim  <span class=\"comment\"># 基础运行环境</span></span><br><span class=\"line\"><span class=\"keyword\">LABEL</span><span class=\"language-bash\"> maintainer=wmchong  <span class=\"comment\"># 作者</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> target/*.jar  /app.jar </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ENTRYPOINT</span><span class=\"language-bash\"> [<span class=\"string\">&quot;java&quot;</span>,<span class=\"string\">&quot;-jar&quot;</span>,<span class=\"string\">&quot;/app.jar&quot;</span>]  <span class=\"comment\"># 镜像的启动命令</span></span></span><br></pre></td></tr></table></figure>\n<p>构建镜像</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker build -t java-demo2:v1.0 .</span><br></pre></td></tr></table></figure>\n<p>启动容器</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d -p 8080:8080 --name chong java-demo2:v1.0</span><br></pre></td></tr></table></figure>\n<p>上传镜像到 dockerhub 仓库</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 登录docker hub</span></span><br><span class=\"line\">docker login</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#给旧镜像起名</span></span><br><span class=\"line\">docker tag java-demo2:v1.0  wmchong/java-demo:v1.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 推送到docker hub</span></span><br><span class=\"line\">docker push wmchong/java-demo:v1.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 别的机器</span></span><br><span class=\"line\">docker pull wmchong/java-demo:v1.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 别的机器运行</span></span><br><span class=\"line\">docker run -d -p 8080:8080 --name myjava-app java-demo:v1.0 </span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "容器技术"
            ]
        }
    ]
}